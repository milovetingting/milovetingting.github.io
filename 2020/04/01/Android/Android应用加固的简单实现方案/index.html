<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"><title>Android应用加固的简单实现方案 | milovetingting</title><meta name="description" content="Android应用加固的简单实现方案"><meta name="keywords" content="Android,加固"><meta name="author" content="milovetingting,milovetingting@gmail.com"><meta name="copyright" content="milovetingting"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/images/favicon.ico"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="https://hm.baidu.com"><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Android应用加固的简单实现方案"><meta name="twitter:description" content="Android应用加固的简单实现方案"><meta name="twitter:image" content="http://www.milovetingting.cn/images/cover_android.jpg"><meta property="og:type" content="article"><meta property="og:title" content="Android应用加固的简单实现方案"><meta property="og:url" content="http://www.milovetingting.cn/2020/04/01/Android/Android%E5%BA%94%E7%94%A8%E5%8A%A0%E5%9B%BA%E7%9A%84%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88/"><meta property="og:site_name" content="milovetingting"><meta property="og:description" content="Android应用加固的简单实现方案"><meta property="og:image" content="http://www.milovetingting.cn/images/cover_android.jpg"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = 'false'
var t = Cookies.get("theme");
if (autoChangeMode == '1'){
const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

if (t === undefined){
  if (isLightMode) activateLightMode()
  else if (isDarkMode) activateDarkMode()
  else if (isNotSpecified || hasNoSupport){
    console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
    now = new Date();
    hour = now.getHours();
    isNight = hour < 6 || hour >= 18
    isNight ? activateDarkMode() : activateLightMode()
}
} else if (t == 'light') activateLightMode()
else activateDarkMode()


} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><link rel="canonical" href="http://www.milovetingting.cn/2020/04/01/Android/Android%E5%BA%94%E7%94%A8%E5%8A%A0%E5%9B%BA%E7%9A%84%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88/"><link rel="prev" title="Android应用加固的简单实现方案(二)" href="http://www.milovetingting.cn/2020/04/04/Android/Android%E5%BA%94%E7%94%A8%E5%8A%A0%E5%9B%BA%E7%9A%84%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88(%E4%BA%8C)/"><link rel="next" title="Android中ANR的触发机制-BroadcastReceiver篇" href="http://www.milovetingting.cn/2020/03/16/Android/Android%E4%B8%ADANR%E7%9A%84%E8%A7%A6%E5%8F%91%E6%9C%BA%E5%88%B6-BroadcastReceiver%E7%AF%87/"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?8ba6d970b7b738df6e65e31041f9ba3e";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  translate: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: {"languages":{"author":"作者: milovetingting","link":"链接: http://www.milovetingting.cn/2020/04/01/Android/Android%E5%BA%94%E7%94%A8%E5%8A%A0%E5%9B%BA%E7%9A%84%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88/","source":"来源: milovetingting","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: {"bookmark":{"title":"Snackbar.bookmark.title","message_prev":"按","message_next":"键将本页加入书签"},"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#2d3035","position":"bottom-left"},
  baiduPush: false,
  isHome: false,
  isPost: true
  
}</script><meta name="generator" content="Hexo 4.2.0"></head><body><header> <div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">milovetingting</a></span><span class="toggle-menu pull_right close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div></div></span><span class="pull_right" id="search_button"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> 搜索</span></a></span></div></header><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/images/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">95</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">78</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">6</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">目录</div><div class="sidebar-toc__content"><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#Android应用加固的简单实现方案"><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">Android应用加固的简单实现方案</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#概述"><span class="toc_mobile_items-number">1.1.</span> <span class="toc_mobile_items-text">概述</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#实现"><span class="toc_mobile_items-number">1.2.</span> <span class="toc_mobile_items-text">实现</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#APK和壳AAR的生成"><span class="toc_mobile_items-number">1.2.1.</span> <span class="toc_mobile_items-text">APK和壳AAR的生成</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#加壳的过程"><span class="toc_mobile_items-number">1.2.2.</span> <span class="toc_mobile_items-text">加壳的过程</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#解压APK"><span class="toc_mobile_items-number">1.2.2.1.</span> <span class="toc_mobile_items-text">解压APK</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#加密解压出来的dex文件、重命名dex文件"><span class="toc_mobile_items-number">1.2.2.2.</span> <span class="toc_mobile_items-text">加密解压出来的dex文件、重命名dex文件</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#解压壳AAR"><span class="toc_mobile_items-number">1.2.2.3.</span> <span class="toc_mobile_items-text">解压壳AAR</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#将jar转成dex"><span class="toc_mobile_items-number">1.2.2.4.</span> <span class="toc_mobile_items-text">将jar转成dex</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#打包"><span class="toc_mobile_items-number">1.2.2.5.</span> <span class="toc_mobile_items-text">打包</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#签名"><span class="toc_mobile_items-number">1.2.2.6.</span> <span class="toc_mobile_items-text">签名</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#源码"><span class="toc_mobile_items-number">1.2.2.7.</span> <span class="toc_mobile_items-text">源码</span></a></li></ol></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#基于gradle的自动加固"><span class="toc_mobile_items-number">1.3.</span> <span class="toc_mobile_items-text">基于gradle的自动加固</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#插件生成"><span class="toc_mobile_items-number">1.3.1.</span> <span class="toc_mobile_items-text">插件生成</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#插件应用"><span class="toc_mobile_items-number">1.3.2.</span> <span class="toc_mobile_items-text">插件应用</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#源码-1"><span class="toc_mobile_items-number">1.3.3.</span> <span class="toc_mobile_items-text">源码</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#插件的实现"><span class="toc_mobile_items-number">1.4.</span> <span class="toc_mobile_items-text">插件的实现</span></a></li></ol></li></ol></div></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Android应用加固的简单实现方案"><span class="toc-number">1.</span> <span class="toc-text">Android应用加固的简单实现方案</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#概述"><span class="toc-number">1.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实现"><span class="toc-number">1.2.</span> <span class="toc-text">实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#APK和壳AAR的生成"><span class="toc-number">1.2.1.</span> <span class="toc-text">APK和壳AAR的生成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#加壳的过程"><span class="toc-number">1.2.2.</span> <span class="toc-text">加壳的过程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#解压APK"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">解压APK</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#加密解压出来的dex文件、重命名dex文件"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">加密解压出来的dex文件、重命名dex文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#解压壳AAR"><span class="toc-number">1.2.2.3.</span> <span class="toc-text">解压壳AAR</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#将jar转成dex"><span class="toc-number">1.2.2.4.</span> <span class="toc-text">将jar转成dex</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#打包"><span class="toc-number">1.2.2.5.</span> <span class="toc-text">打包</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#签名"><span class="toc-number">1.2.2.6.</span> <span class="toc-text">签名</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#源码"><span class="toc-number">1.2.2.7.</span> <span class="toc-text">源码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#基于gradle的自动加固"><span class="toc-number">1.3.</span> <span class="toc-text">基于gradle的自动加固</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#插件生成"><span class="toc-number">1.3.1.</span> <span class="toc-text">插件生成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#插件应用"><span class="toc-number">1.3.2.</span> <span class="toc-text">插件应用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#源码-1"><span class="toc-number">1.3.3.</span> <span class="toc-text">源码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#插件的实现"><span class="toc-number">1.4.</span> <span class="toc-text">插件的实现</span></a></li></ol></li></ol></div></div></div><main id="content-outer"><div id="top-container" style="background-image: url(/images/cover_android.jpg)"><div id="post-info"><div id="post-title"><div class="posttitle">Android应用加固的简单实现方案</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 发表于 2020-04-01<span class="post-meta__separator">|</span><i class="fa fa-history fa-fw" aria-hidden="true"></i> 更新于 2020-04-05</time><span class="post-meta__separator">|</span><span><i class="fa fa-inbox post-meta__icon fa-fw" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Android/">Android</a></span><div class="post-meta-wordcount"><i class="fa fa-file-word-o post-meta__icon fa-fw" aria-hidden="true"></i><span>字数总计:</span><span class="word-count">3k</span><span class="post-meta__separator">|</span><i class="fa fa-clock-o post-meta__icon fa-fw" aria-hidden="true"></i><span>阅读时长: 14 分钟</span><div class="post-meta-pv-cv"><span class="post-meta__separator">|</span><span><i class="fa fa-eye post-meta__icon fa-fw" aria-hidden="true"> </i>阅读量:</span><span id="busuanzi_value_page_pv"></span><span class="post-meta__separator">|</span><i class="fa fa-comments-o post-meta__icon fa-fw" aria-hidden="true"></i><span>评论数:</span><a href="/2020/04/01/Android/Android%E5%BA%94%E7%94%A8%E5%8A%A0%E5%9B%BA%E7%9A%84%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88/#post-comment"><span class="gitalk-comment-count comment-count"></span></a></div></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><blockquote>
<p>个人博客</p>
<p><a href="http://www.milovetingting.cn">http://www.milovetingting.cn</a></p>
</blockquote>
<h1 id="Android应用加固的简单实现方案"><a href="#Android应用加固的简单实现方案" class="headerlink" title="Android应用加固的简单实现方案"></a>Android应用加固的简单实现方案</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>Android应用加固的诸多方案中，其中一种就是基于dex的加固,本文介绍基于dex的加固方案。</p>
<p>原理：在AndroidManifest中指定启动Application为壳Module的Application,生成APK后，将壳Module的AAR文件和加密后的APK中的dex文件合并，然后重新打包签名。安装应用运行后，通过壳Module的Application来解密dex文件，然后再加载dex。</p>
<p>存在的问题：解密过程，会还原出来未加密的原dex文件，通过一些手段，还是可以获得未加密的dex。</p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><h3 id="APK和壳AAR的生成"><a href="#APK和壳AAR的生成" class="headerlink" title="APK和壳AAR的生成"></a>APK和壳AAR的生成</h3><p>新建工程，然后新建一个Module，作为壳Module，名字随意，这里命名为shell。</p>
<p><a href="/images/%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84.png" data-fancybox="group" data-caption="项目结构" class="fancybox"><img alt="项目结构" title="项目结构" data-src="/images/%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84.png" src="/img/loading.gif" class="lazyload"></a></p>
<p>在壳Module中新建继承自Application的ShellApplication,重写attachBaseContext方法,在这个方法加载原来的dex</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShellApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">attachBaseContext</span><span class="params">(Context base)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.attachBaseContext(base);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//获取应用APK</span></span><br><span class="line">            File apkFile = <span class="keyword">new</span> File(getApplicationInfo().sourceDir);</span><br><span class="line">            <span class="comment">//解压目录</span></span><br><span class="line">            File apkUnzipDir = getDir(<span class="string">"apk"</span>, Context.MODE_PRIVATE);</span><br><span class="line">            apkUnzipDir = <span class="keyword">new</span> File(apkUnzipDir, <span class="string">"unzip"</span>);</span><br><span class="line">            <span class="comment">//如果不存在，则解压</span></span><br><span class="line">            <span class="keyword">if</span> (!apkUnzipDir.exists()) &#123;</span><br><span class="line">                apkUnzipDir.mkdirs();</span><br><span class="line">                <span class="comment">//解压</span></span><br><span class="line">                ZipUtils.unzipFile(apkFile, apkUnzipDir);</span><br><span class="line">                <span class="comment">//过滤所有.dex文件</span></span><br><span class="line">                File[] files = apkUnzipDir.listFiles(<span class="keyword">new</span> FilenameFilter() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">accept</span><span class="params">(File dir, String name)</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">return</span> name.endsWith(<span class="string">".dex"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">                <span class="comment">//解密</span></span><br><span class="line">                File decryptDir = <span class="keyword">new</span> File(apkUnzipDir, <span class="string">"decrypt"</span>);</span><br><span class="line">                decryptDir.mkdirs();</span><br><span class="line">                ArrayList&lt;File&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">                <span class="keyword">for</span> (File file : files) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (file.getName().endsWith(<span class="string">"classes.dex"</span>)) &#123;</span><br><span class="line">                        list.add(file);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        File decryptFile = <span class="keyword">new</span> File(decryptDir, file.getName());</span><br><span class="line">                        EncryptUtils.decrypt(file.getAbsolutePath(), decryptFile.getAbsolutePath());</span><br><span class="line">                        <span class="comment">//添加到list中</span></span><br><span class="line">                        list.add(decryptFile);</span><br><span class="line">                        <span class="comment">//删除加密的dex文件</span></span><br><span class="line">                        file.delete();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//加载.dex文件</span></span><br><span class="line">                ClassLoaderUtil.loadDex(<span class="keyword">this</span>, list);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ArrayList&lt;File&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">                list.add(<span class="keyword">new</span> File(apkUnzipDir, <span class="string">"classes.dex"</span>));</span><br><span class="line">                File decryptDir = <span class="keyword">new</span> File(apkUnzipDir, <span class="string">"decrypt"</span>);</span><br><span class="line">                File[] files = decryptDir.listFiles();</span><br><span class="line">                <span class="keyword">for</span> (File file : files) &#123;</span><br><span class="line">                    list.add(file);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//加载.dex文件</span></span><br><span class="line">                ClassLoaderUtil.loadDex(<span class="keyword">this</span>, list);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>修改app的AndroidManifest中application节点的name为壳Module的Application</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">xml</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">application</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:name</span>=<span class="string">"com.wangyz.shell.ShellApplication"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:allowBackup</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:icon</span>=<span class="string">"@mipmap/ic_launcher"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:label</span>=<span class="string">"@string/app_name"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:roundIcon</span>=<span class="string">"@mipmap/ic_launcher_round"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:supportsRtl</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:theme</span>=<span class="string">"@style/AppTheme"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">".MainActivity"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"android.intent.action.MAIN"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">                <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">"android.intent.category.LAUNCHER"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<p>在Gradle面板，双击app/Tasks/build/目录下的assembleRelease,生成未签名的APK</p>
<p><a href="/images/%E7%94%9F%E6%88%90apk.png" data-fancybox="group" data-caption="生成apk" class="fancybox"><img alt="生成apk" title="生成apk" data-src="/images/%E7%94%9F%E6%88%90apk.png" src="/img/loading.gif" class="lazyload"></a></p>
<p>在app/build/outputs/apk/release/目录下，可以找到生成的apk:app-release-unsigned.apk</p>
<p>在Android Studio中，点击Build-Make Module ‘shell’,生成AAR。</p>
<p><a href="/images/%E7%94%9F%E6%88%90aar.png" data-fancybox="group" data-caption="生成aar" class="fancybox"><img alt="生成aar" title="生成aar" data-src="/images/%E7%94%9F%E6%88%90aar.png" src="/img/loading.gif" class="lazyload"></a></p>
<p>在shell/build/outputs/aar/目录下，可以找到生成的aar:shell-debug.aar</p>
<h3 id="加壳的过程"><a href="#加壳的过程" class="headerlink" title="加壳的过程"></a>加壳的过程</h3><p>加壳的实现流程如下：</p>
<p><a href="/images/%E5%8A%A0%E5%A3%B3.png" data-fancybox="group" data-caption="加壳" class="fancybox"><img alt="加壳" title="加壳" data-src="/images/%E5%8A%A0%E5%A3%B3.png" src="/img/loading.gif" class="lazyload"></a></p>
<p>这里选择Eclipse新建Java工程来操作。</p>
<p><a href="/images/%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%842.png" data-fancybox="group" data-caption="项目结构2" class="fancybox"><img alt="项目结构2" title="项目结构2" data-src="/images/%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%842.png" src="/img/loading.gif" class="lazyload"></a></p>
<p>项目结构说明：</p>
<ol>
<li><p>input：存放需要加壳的apk和aar</p>
</li>
<li><p>keystore:存放签名用到的keystore文件</p>
</li>
<li><p>output:打包后输出目录，signed为签名后的apk</p>
</li>
</ol>
<p>需要配置的环境变量：</p>
<ol>
<li><p>由于要用到dx来将jar转换成dex，因此需要配置dx的路径。在SDK/build-tools/下，有对应不同版本的build工具，这里选择28.0.0，进入28.0.0文件夹，可以看到dx.bat文件。在电脑的环境变量中，修改path，增加dx.bat路径：</p>
<p> <a href="/images/dx%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E9%85%8D%E7%BD%AE.png" data-fancybox="group" data-caption="dx环境变量配置" class="fancybox"><img alt="dx环境变量配置" title="dx环境变量配置" data-src="/images/dx%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E9%85%8D%E7%BD%AE.png" src="/img/loading.gif" class="lazyload"></a></p>
</li>
<li><p>由于要用到jarsigner来签名apk，因此需要配置jarsigner的环境变量。一般Java开发的话，JDK配置好了后，这个就不需要再配置了。</p>
</li>
</ol>
<p>配置好上面的环境变量后，关掉eclipse,然后重新启动eclipse</p>
<p>Main类中的代码逻辑：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="comment">// APK</span></span><br><span class="line">			File apkFile = <span class="keyword">new</span> File(<span class="string">"input/app-debug.apk"</span>);</span><br><span class="line">			<span class="comment">// 壳AAR</span></span><br><span class="line">			File shellFile = <span class="keyword">new</span> File(<span class="string">"input/shell-debug.aar"</span>);</span><br><span class="line">			<span class="comment">// 判断文件是否存在</span></span><br><span class="line">			<span class="keyword">if</span> (!apkFile.exists() || !shellFile.exists()) &#123;</span><br><span class="line">				System.out.println(<span class="string">"apkFile or shellFile missing"</span>);</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// *************解压APK*************</span></span><br><span class="line">			System.out.println(<span class="string">"解压APK"</span>);</span><br><span class="line">			<span class="comment">// 先删除输出文件夹下的所有文件</span></span><br><span class="line">			File outputDir = <span class="keyword">new</span> File(<span class="string">"output/"</span>);</span><br><span class="line">			<span class="keyword">if</span> (outputDir.exists()) &#123;</span><br><span class="line">				FileUtils.deleteAllInDir(outputDir);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// 创建apk的解压目录</span></span><br><span class="line">			File apkUnzipDir = <span class="keyword">new</span> File(<span class="string">"output/unzip/apk/"</span>);</span><br><span class="line">			<span class="keyword">if</span> (!apkUnzipDir.exists()) &#123;</span><br><span class="line">				apkUnzipDir.mkdirs();</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// 解压APK</span></span><br><span class="line">			ZipUtil.unZip(apkFile, apkUnzipDir);</span><br><span class="line">			<span class="comment">// 删除META-INF/CERT.RSA,META-INF/CERT.SF,META-INF/MANIFEST.MF</span></span><br><span class="line">			File certRSA = <span class="keyword">new</span> File(apkUnzipDir, <span class="string">"/META-INF/CERT.RSA"</span>);</span><br><span class="line">			certRSA.delete();</span><br><span class="line">			File certSF = <span class="keyword">new</span> File(apkUnzipDir, <span class="string">"/META-INF/CERT.SF"</span>);</span><br><span class="line">			certSF.delete();</span><br><span class="line">			File manifestMF = <span class="keyword">new</span> File(apkUnzipDir, <span class="string">"/META-INF/MANIFEST.MF"</span>);</span><br><span class="line">			manifestMF.delete();</span><br><span class="line">			<span class="comment">// 获取dex文件</span></span><br><span class="line">			File[] apkFiles = apkUnzipDir.listFiles(<span class="keyword">new</span> FilenameFilter() &#123;</span><br><span class="line"></span><br><span class="line">				<span class="meta">@Override</span></span><br><span class="line">				<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">accept</span><span class="params">(File file, String s)</span> </span>&#123;</span><br><span class="line">					<span class="keyword">return</span> s.endsWith(<span class="string">".dex"</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;);</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = apkFiles.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">				File file = apkFiles[i];</span><br><span class="line">				String name = file.getName();</span><br><span class="line">				System.out.println(<span class="string">"dex:"</span> + name);</span><br><span class="line">				String bakName = name.substring(<span class="number">0</span>, name.indexOf(<span class="string">".dex"</span>)) + <span class="string">"_bak.dex"</span>;</span><br><span class="line">				System.out.println(<span class="string">"备份dex:"</span> + bakName);</span><br><span class="line">				bakName = file.getParent() + File.separator + name.substring(<span class="number">0</span>, name.indexOf(<span class="string">".dex"</span>)) + <span class="string">"_bak.dex"</span>;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// 加密dex文件</span></span><br><span class="line">				EncryptUtils.encrypt(file.getAbsolutePath(), bakName);</span><br><span class="line">				System.out.println(<span class="string">"加密dex:"</span> + name);</span><br><span class="line">				<span class="comment">// 删除原文件</span></span><br><span class="line">				file.delete();</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// *************解压APK*************</span></span><br><span class="line"></span><br><span class="line">			<span class="comment">// *************解压壳AAR*************</span></span><br><span class="line">			<span class="comment">// 创建壳AAR的解压目录</span></span><br><span class="line">			System.out.println(<span class="string">"解压壳AAR"</span>);</span><br><span class="line">			File shellUnzipDir = <span class="keyword">new</span> File(<span class="string">"output/unzip/shell/"</span>);</span><br><span class="line">			<span class="keyword">if</span> (!shellUnzipDir.exists()) &#123;</span><br><span class="line">				shellUnzipDir.mkdirs();</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// 解压AAR</span></span><br><span class="line">			ZipUtil.unZip(shellFile, shellUnzipDir);</span><br><span class="line">			<span class="comment">// 将jar转成dex</span></span><br><span class="line">			System.out.println(<span class="string">"将jar转成dex"</span>);</span><br><span class="line">			File shellJar = <span class="keyword">new</span> File(shellUnzipDir, <span class="string">"classes.jar"</span>);</span><br><span class="line">			File shellDex = <span class="keyword">new</span> File(apkUnzipDir, <span class="string">"classes.dex"</span>);</span><br><span class="line">			DexUtils.dxCommand(shellJar, shellDex);</span><br><span class="line">			<span class="comment">// 打包</span></span><br><span class="line">			System.out.println(<span class="string">"打包APK"</span>);</span><br><span class="line">			File unsignedApk = <span class="keyword">new</span> File(<span class="string">"output/unsigned.apk"</span>);</span><br><span class="line">			ZipUtil.zip(apkUnzipDir, unsignedApk);</span><br><span class="line">			<span class="comment">// 删除解压目录</span></span><br><span class="line"></span><br><span class="line">			FileUtils.delete(<span class="string">"output/unzip/"</span>);</span><br><span class="line">			System.out.println(<span class="string">"签名APK"</span>);</span><br><span class="line">			File signedApk = <span class="keyword">new</span> File(<span class="string">"output/signed.apk"</span>);</span><br><span class="line">			SignUtils.signature(unsignedApk, signedApk, <span class="string">"keystore/android.keystore"</span>);</span><br><span class="line">			System.out.println(<span class="string">"Finished!!!"</span>);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// *************解压壳AAR*************</span></span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure></div>

<p>来看下具体的步骤：</p>
<h4 id="解压APK"><a href="#解压APK" class="headerlink" title="解压APK"></a>解压APK</h4><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">File apkUnzipDir = <span class="keyword">new</span> File(root, <span class="string">"/output/unzip/apk/"</span>);</span><br><span class="line"><span class="keyword">if</span> (!apkUnzipDir.exists()) &#123;</span><br><span class="line">    apkUnzipDir.mkdirs();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 解压APK</span></span><br><span class="line">ZipUtil.unZip(apkFile, apkUnzipDir);</span><br></pre></td></tr></table></figure></div>

<h4 id="加密解压出来的dex文件、重命名dex文件"><a href="#加密解压出来的dex文件、重命名dex文件" class="headerlink" title="加密解压出来的dex文件、重命名dex文件"></a>加密解压出来的dex文件、重命名dex文件</h4><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取dex文件</span></span><br><span class="line">            File[] apkFiles = apkUnzipDir.listFiles((file, s) -&gt; s.endsWith(<span class="string">".dex"</span>));</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = apkFiles.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">                File file = apkFiles[i];</span><br><span class="line">                String name = file.getName();</span><br><span class="line">                System.out.println(<span class="string">"dex:"</span> + name);</span><br><span class="line">                String bakName = name.substring(<span class="number">0</span>, name.indexOf(<span class="string">".dex"</span>)) + <span class="string">"_bak.dex"</span>;</span><br><span class="line">                System.out.println(<span class="string">"备份dex:"</span> + bakName);</span><br><span class="line">                bakName = file.getParent() + File.separator + name.substring(<span class="number">0</span>, name.indexOf(<span class="string">".dex"</span>)) + <span class="string">"_bak.dex"</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 加密dex文件</span></span><br><span class="line">                EncryptUtils.encrypt(file.getAbsolutePath(), bakName);</span><br><span class="line">                System.out.println(<span class="string">"加密dex:"</span> + name);</span><br><span class="line">                <span class="comment">// 删除原文件</span></span><br><span class="line">                file.delete();</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="解压壳AAR"><a href="#解压壳AAR" class="headerlink" title="解压壳AAR"></a>解压壳AAR</h4><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">File shellUnzipDir = <span class="keyword">new</span> File(root, <span class="string">"/output/unzip/shell/"</span>);</span><br><span class="line"><span class="keyword">if</span> (!shellUnzipDir.exists()) &#123;</span><br><span class="line">    shellUnzipDir.mkdirs();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 解压AAR</span></span><br><span class="line">ZipUtil.unZip(shellFile, shellUnzipDir);</span><br></pre></td></tr></table></figure></div>

<h4 id="将jar转成dex"><a href="#将jar转成dex" class="headerlink" title="将jar转成dex"></a>将jar转成dex</h4><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">File shellJar = <span class="keyword">new</span> File(shellUnzipDir, <span class="string">"classes.jar"</span>);</span><br><span class="line">File shellDex = <span class="keyword">new</span> File(apkUnzipDir, <span class="string">"classes.dex"</span>);</span><br><span class="line">DexUtils.dxCommand(shellJar, shellDex);</span><br></pre></td></tr></table></figure></div>

<h4 id="打包"><a href="#打包" class="headerlink" title="打包"></a>打包</h4><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">File unsignedApk = <span class="keyword">new</span> File(root, <span class="string">"/output/unsigned.apk"</span>);</span><br><span class="line">ZipUtil.zip(apkUnzipDir, unsignedApk);</span><br></pre></td></tr></table></figure></div>

<h4 id="签名"><a href="#签名" class="headerlink" title="签名"></a>签名</h4><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FileUtils.delete(<span class="keyword">new</span> File(root, <span class="string">"output/unzip/"</span>));</span><br><span class="line">System.out.println(<span class="string">"签名APK"</span>);</span><br><span class="line">File signedApk = <span class="keyword">new</span> File(root, <span class="string">"output/signed.apk"</span>);</span><br><span class="line">SignUtils.signature(unsignedApk, signedApk, keystore, keyStorePassword, keyPassword, alias);</span><br><span class="line">System.out.println(<span class="string">"Finished!!!"</span>);</span><br></pre></td></tr></table></figure></div>

<p>在output目录下，可以看到已经生成signed.apk。将apk安装在手机上，可以正常运行，达到加固的目的。</p>
<h4 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h4><p>源码地址:<a href="https://github.com/milovetingting/Samples/tree/master/Shell/%E5%8A%A0%E5%9B%BA-%E6%89%8B%E5%8A%A8%E5%8A%A0%E5%A3%B3" target="_blank" rel="noopener">https://github.com/milovetingting/Samples/tree/master/Shell/%E5%8A%A0%E5%9B%BA-%E6%89%8B%E5%8A%A8%E5%8A%A0%E5%A3%B3</a></p>
<h2 id="基于gradle的自动加固"><a href="#基于gradle的自动加固" class="headerlink" title="基于gradle的自动加固"></a>基于gradle的自动加固</h2><p>上面的加固方式，需要在生成APK后，再生成壳Module的AAR文件，然后再通过工具来生成加固的APK。这个过程，手动操作还是比较麻烦的。可以借助gradle来生成插件，在生成APK后，自动完成加固。</p>
<h3 id="插件生成"><a href="#插件生成" class="headerlink" title="插件生成"></a>插件生成</h3><p>新建工程Plugins,新建module,名为shell,作为加壳的插件。</p>
<p>清空shell模块下的build文件内容修改如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">gradle</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">apply plugin: <span class="string">'groovy'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    implementation gradleApi()</span><br><span class="line">    implementation localGroovy()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>删除shell模块下的src/main/目录下的所有文件，然后新建目录groovy，在groovy中再新建包:com/wangyz/plugins,具体可以根据实际情况修改。</p>
<p>新建ShellConfig.java，作为自定义配置的bean</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShellConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 壳Module名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String shellModuleName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * keystore的位置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String keyStore;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * keystore的密码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String keyStorePassword;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * key的密码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String keyPassword;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 别名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String alias;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>新建ShellPlugin.groovy，主要的逻辑都在这里面</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">groovy</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wangyz.plugins</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wangyz.plugins.util.ShellUtil</span><br><span class="line"><span class="keyword">import</span> org.gradle.api.Plugin</span><br><span class="line"><span class="keyword">import</span> org.gradle.api.Project</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShellPlugin</span> <span class="keyword">implements</span> <span class="title">Plugin</span>&lt;<span class="title">Project</span>&gt; &#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> printLog(Object msg) &#123;</span><br><span class="line">        println(<span class="string">"******************************"</span>)</span><br><span class="line">        println(msg)</span><br><span class="line">        println(<span class="string">"******************************\n"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> createDir(Project project) &#123;</span><br><span class="line">        File shellDir = <span class="keyword">new</span> File(<span class="string">"$&#123;project.rootDir&#125;/ShellAPK"</span>)</span><br><span class="line">        <span class="keyword">if</span> (!shellDir.exists()) &#123;</span><br><span class="line">            printLog(<span class="string">"create dir"</span>)</span><br><span class="line">            shellDir.mkdirs()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> deleteDir(Project project) &#123;</span><br><span class="line">        File shellDir = <span class="keyword">new</span> File(<span class="string">"$&#123;project.rootDir&#125;/ShellAPK"</span>)</span><br><span class="line">        <span class="keyword">if</span> (shellDir.exists()) &#123;</span><br><span class="line">            printLog(<span class="string">"delete dir"</span>)</span><br><span class="line">            shellDir.deleteDir()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">void</span> apply(Project project) &#123;</span><br><span class="line"></span><br><span class="line">        printLog(<span class="string">'ShellPlugin apply'</span>)</span><br><span class="line"></span><br><span class="line">        project.extensions.create(<span class="string">"shellConfig"</span>, ShellConfig)</span><br><span class="line"></span><br><span class="line">        project.afterEvaluate &#123;</span><br><span class="line">            project.tasks.matching &#123;</span><br><span class="line">                it.name == <span class="string">'assembleRelease'</span></span><br><span class="line">            &#125;.each &#123;</span><br><span class="line">                task -&gt;</span><br><span class="line">                    printLog(task.name)</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">def</span> shellProject = project.parent.findProject(<span class="string">"$&#123;project.shellConfig.shellModuleName&#125;"</span>)</span><br><span class="line">                    printLog(<span class="string">"shellProject:$shellProject"</span>)</span><br><span class="line"></span><br><span class="line">                    File shellDir = <span class="keyword">new</span> File(<span class="string">"$&#123;project.rootDir&#125;/ShellAPK"</span>)</span><br><span class="line"></span><br><span class="line">                    File apkFile</span><br><span class="line"></span><br><span class="line">                    File aarFile = <span class="keyword">new</span> File(<span class="string">"$&#123;shellProject.buildDir&#125;/outputs/aar/shell-release.aar"</span>)</span><br><span class="line"></span><br><span class="line">                    project.android.applicationVariants.all &#123;</span><br><span class="line">                        variant -&gt;</span><br><span class="line">                            variant.outputs.each &#123;</span><br><span class="line">                                output -&gt;</span><br><span class="line">                                    <span class="keyword">def</span> outputFile = output.outputFile</span><br><span class="line">                                    printLog(<span class="string">"outputFile:$&#123;outputFile.getAbsolutePath()&#125;"</span>)</span><br><span class="line">                                    <span class="keyword">if</span> (outputFile.name.contains(<span class="string">"release"</span>)) &#123;</span><br><span class="line">                                        apkFile = outputFile</span><br><span class="line">                                    &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    task.doFirst &#123;</span><br><span class="line">                        <span class="comment">//删除原来的文件夹</span></span><br><span class="line">                        deleteDir(project)</span><br><span class="line">                        <span class="comment">//生成文件夹</span></span><br><span class="line">                        createDir(project)</span><br><span class="line">                        <span class="comment">//生成aar</span></span><br><span class="line">                        printLog(<span class="string">"begin generate aar"</span>)</span><br><span class="line">                        project.exec &#123;</span><br><span class="line">                            workingDir(<span class="string">"../$&#123;project.shellConfig.shellModuleName&#125;/"</span>)</span><br><span class="line">                            commandLine(<span class="string">'cmd'</span>, <span class="string">'/c'</span>, <span class="string">'gradle'</span>, <span class="string">'assembleRelease'</span>)</span><br><span class="line">                        &#125;</span><br><span class="line">                        printLog(<span class="string">"generate aar complete"</span>)</span><br><span class="line"></span><br><span class="line">                        <span class="comment">//复制文件</span></span><br><span class="line">                        printLog(<span class="string">"begin copy aar"</span>)</span><br><span class="line">                        project.copy &#123;</span><br><span class="line">                            from aarFile</span><br><span class="line">                            into shellDir</span><br><span class="line">                        &#125;</span><br><span class="line">                        printLog(<span class="string">"copy aar complete"</span>)</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    task.doLast &#123;</span><br><span class="line">                        printLog(<span class="string">"begin copy apk"</span>)</span><br><span class="line">                        <span class="comment">//复制文件</span></span><br><span class="line">                        project.copy &#123;</span><br><span class="line">                            from apkFile</span><br><span class="line">                            into shellDir</span><br><span class="line">                        &#125;</span><br><span class="line">                        printLog(<span class="string">"copy $&#123;apkFile.name&#125; complete"</span>)</span><br><span class="line"></span><br><span class="line">                        printLog(<span class="string">"begin shell"</span>)</span><br><span class="line"></span><br><span class="line">                        ShellUtil.shell(apkFile.getAbsolutePath(), aarFile.getAbsolutePath(), shellDir.getAbsolutePath(), project.shellConfig.keyStore, project.shellConfig.keyStorePassword, project.shellConfig.keyPassword, project.shellConfig.alias)</span><br><span class="line"></span><br><span class="line">                        printLog(<span class="string">"end shell"</span>)</span><br><span class="line">                    &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ShellPlugin类实现Plugin接口,实现apply方法，当插件被apply时，就会回调这个方法。</p>
<p>首先创建配置,这样引用插件的gradle文件就可以定义shellConfig节点，插件就可以拿到配置节点里的内容</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">groovy</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">project.extensions.create(<span class="string">"shellConfig"</span>, ShellConfig)</span><br></pre></td></tr></table></figure></div>

<p>指定在assembleRelease后执行我们自己的逻辑</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">groovy</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">project.afterEvaluate &#123;</span><br><span class="line">            project.tasks.matching &#123;</span><br><span class="line">                it.name == <span class="string">'assembleRelease'</span></span><br><span class="line">            &#125;.each &#123;</span><br><span class="line">                task -&gt;</span><br><span class="line">                    printLog(task.name)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></div>

<p>具体的逻辑定义在task的闭包中,在生成apk前，执行task.doFirst里的逻辑，首先生成aar，然后执行生成apk的逻辑，然后在task.doLast中执行加壳的操作。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">groovy</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">printLog(task.name)</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">def</span> shellProject = project.parent.findProject(<span class="string">"$&#123;project.shellConfig.shellModuleName&#125;"</span>)</span><br><span class="line">                    printLog(<span class="string">"shellProject:$shellProject"</span>)</span><br><span class="line"></span><br><span class="line">                    File shellDir = <span class="keyword">new</span> File(<span class="string">"$&#123;project.rootDir&#125;/ShellAPK"</span>)</span><br><span class="line"></span><br><span class="line">                    File apkFile</span><br><span class="line"></span><br><span class="line">                    File aarFile = <span class="keyword">new</span> File(<span class="string">"$&#123;shellProject.buildDir&#125;/outputs/aar/shell-release.aar"</span>)</span><br><span class="line"></span><br><span class="line">                    project.android.applicationVariants.all &#123;</span><br><span class="line">                        variant -&gt;</span><br><span class="line">                            variant.outputs.each &#123;</span><br><span class="line">                                output -&gt;</span><br><span class="line">                                    <span class="keyword">def</span> outputFile = output.outputFile</span><br><span class="line">                                    printLog(<span class="string">"outputFile:$&#123;outputFile.getAbsolutePath()&#125;"</span>)</span><br><span class="line">                                    <span class="keyword">if</span> (outputFile.name.contains(<span class="string">"release"</span>)) &#123;</span><br><span class="line">                                        apkFile = outputFile</span><br><span class="line">                                    &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    task.doFirst &#123;</span><br><span class="line">                        <span class="comment">//删除原来的文件夹</span></span><br><span class="line">                        deleteDir(project)</span><br><span class="line">                        <span class="comment">//生成文件夹</span></span><br><span class="line">                        createDir(project)</span><br><span class="line">                        <span class="comment">//生成aar</span></span><br><span class="line">                        printLog(<span class="string">"begin generate aar"</span>)</span><br><span class="line">                        project.exec &#123;</span><br><span class="line">                            workingDir(<span class="string">"../$&#123;project.shellConfig.shellModuleName&#125;/"</span>)</span><br><span class="line">                            commandLine(<span class="string">'cmd'</span>, <span class="string">'/c'</span>, <span class="string">'gradle'</span>, <span class="string">'assembleRelease'</span>)</span><br><span class="line">                        &#125;</span><br><span class="line">                        printLog(<span class="string">"generate aar complete"</span>)</span><br><span class="line"></span><br><span class="line">                        <span class="comment">//复制文件</span></span><br><span class="line">                        printLog(<span class="string">"begin copy aar"</span>)</span><br><span class="line">                        project.copy &#123;</span><br><span class="line">                            from aarFile</span><br><span class="line">                            into shellDir</span><br><span class="line">                        &#125;</span><br><span class="line">                        printLog(<span class="string">"copy aar complete"</span>)</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    task.doLast &#123;</span><br><span class="line">                        printLog(<span class="string">"begin copy apk"</span>)</span><br><span class="line">                        <span class="comment">//复制文件</span></span><br><span class="line">                        project.copy &#123;</span><br><span class="line">                            from apkFile</span><br><span class="line">                            into shellDir</span><br><span class="line">                        &#125;</span><br><span class="line">                        printLog(<span class="string">"copy $&#123;apkFile.name&#125; complete"</span>)</span><br><span class="line"></span><br><span class="line">                        printLog(<span class="string">"begin shell"</span>)</span><br><span class="line"></span><br><span class="line">                        ShellUtil.shell(apkFile.getAbsolutePath(), aarFile.getAbsolutePath(), shellDir.getAbsolutePath(), project.shellConfig.keyStore, project.shellConfig.keyStorePassword, project.shellConfig.keyPassword, project.shellConfig.alias)</span><br><span class="line"></span><br><span class="line">                        printLog(<span class="string">"end shell"</span>)</span><br><span class="line">                    &#125;</span><br></pre></td></tr></table></figure></div>

<p>在src/main/目录下新建目录：resources/META-INF/gradle-plugins，再创建com.wangyz.plugins.ShellPlugin.properties的文件，这里的文件名就是后面插件被引用时的名字，com.wangyz.plugins.ShellPlugin.properties内容如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">implementation-class&#x3D;com.wangyz.plugins.ShellPlugin</span><br></pre></td></tr></table></figure></div>

<p>key为implementation-class,这个是固定的</p>
<p>value为com.wangyz.plugins.ShellPlugin，就是上面在groovy里创建的类</p>
<p>到这里，定义好了插件，还需要发布到仓库。在shell模块的build.gradle文件中增加以下配置</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">apply plugin: &#39;maven-publish&#39;</span><br><span class="line"></span><br><span class="line">publishing &#123;</span><br><span class="line">    publications &#123;</span><br><span class="line">        mavenJava(MavenPublication) &#123;</span><br><span class="line">            groupId &#39;com.wangyz.plugins&#39;</span><br><span class="line">            artifactId &#39;ShellPlugin&#39;</span><br><span class="line">            version &#39;1.0.0&#39;</span><br><span class="line"></span><br><span class="line">            from components.java</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">publishing &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        maven &#123;</span><br><span class="line">            url uri(&#39;E:\\Repository&#39;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>sync项目后，可以在Gradle面板看到新生成的task</p>
<p><a href="/images/%E5%88%9B%E5%BB%BA%E5%8F%91%E5%B8%83task.png" data-fancybox="group" data-caption="创建发布task" class="fancybox"><img alt="创建发布task" title="创建发布task" data-src="/images/%E5%88%9B%E5%BB%BA%E5%8F%91%E5%B8%83task.png" src="/img/loading.gif" class="lazyload"></a></p>
<p>双击publish，会将插件发布到我们指定的仓库</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">11:22:39: Executing task &#39;publish&#39;...</span><br><span class="line"></span><br><span class="line">Executing tasks: [publish] in project D:\Project\Plugins\shell</span><br><span class="line"></span><br><span class="line">Parallel execution with configuration on demand is an incubating feature.</span><br><span class="line">:shell:generatePomFileForMavenJavaPublication</span><br><span class="line">:shell:compileJava NO-SOURCE</span><br><span class="line">:shell:compileGroovy UP-TO-DATE</span><br><span class="line">:shell:processResources UP-TO-DATE</span><br><span class="line">:shell:classes UP-TO-DATE</span><br><span class="line">:shell:jar UP-TO-DATE</span><br><span class="line">Could not find metadata com.wangyz.plugins:ShellPlugin&#x2F;maven-metadata.xml in remote (file:&#x2F;E:&#x2F;Repository)</span><br><span class="line">:shell:publishMavenJavaPublicationToMavenRepository</span><br><span class="line">:shell:publish</span><br><span class="line"></span><br><span class="line">BUILD SUCCESSFUL in 0s</span><br><span class="line">5 actionable tasks: 2 executed, 3 up-to-date</span><br><span class="line">11:22:40: Task execution finished &#39;publish&#39;.</span><br></pre></td></tr></table></figure></div>

<p><a href="/images/%E5%8F%91%E5%B8%83%E6%8F%92%E4%BB%B6.png" data-fancybox="group" data-caption="发布插件" class="fancybox"><img alt="发布插件" title="发布插件" data-src="/images/%E5%8F%91%E5%B8%83%E6%8F%92%E4%BB%B6.png" src="/img/loading.gif" class="lazyload"></a></p>
<h3 id="插件应用"><a href="#插件应用" class="headerlink" title="插件应用"></a>插件应用</h3><p>在需要加壳的工程的根build.gradle中引入插件:</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">gradle</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">buildscript</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">repositories</span> &#123;</span><br><span class="line">        maven &#123;</span><br><span class="line">            url uri(<span class="string">'E:\\Repository'</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">dependencies</span> &#123;</span><br><span class="line">        <span class="keyword">classpath</span> <span class="string">'com.wangyz.plugins:ShellPlugin:1.0.0'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">allprojects</span> &#123;</span><br><span class="line">    <span class="keyword">repositories</span> &#123;</span><br><span class="line">        maven &#123;</span><br><span class="line">            url uri(<span class="string">'E:\\Repository'</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>在app的build.gradle中应用插件:</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">gradle</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//引入插件</span></span><br><span class="line">apply plugin: <span class="string">'com.wangyz.plugins.ShellPlugin'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//配置插件</span></span><br><span class="line">shellConfig &#123;</span><br><span class="line">    shellModuleName = <span class="string">'shell'</span></span><br><span class="line">    keyStore = <span class="string">'E:\\Code\\Android\\android.keystore'</span></span><br><span class="line">    keyStorePassword = <span class="string">'android'</span></span><br><span class="line">    keyPassword = <span class="string">'android'</span></span><br><span class="line">    alias = <span class="string">'android'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><a href="/images/%E7%94%9F%E6%88%90apk.png" data-fancybox="group" data-caption="生成apk" class="fancybox"><img alt="生成apk" title="生成apk" data-src="/images/%E7%94%9F%E6%88%90apk.png" src="/img/loading.gif" class="lazyload"></a></p>
<p>由于插件中会用到gradle命令，因此需要先配置gradle的路径到环境变量path中。具体配置，可以找下相关资料，这里不再展开。</p>
<p>双击执行assembleRelease命令,就会在根目录/ShellApk/output/下生成加壳签名后的apk。</p>
<p>安装加壳签名后的apk,可以正常运行。</p>
<h3 id="源码-1"><a href="#源码-1" class="headerlink" title="源码"></a>源码</h3><p>源码地址：<a href="https://github.com/milovetingting/Samples/tree/master/Shell/%E5%8A%A0%E5%9B%BA-gradle%E6%8F%92%E4%BB%B6%E5%8A%A0%E5%A3%B3" target="_blank" rel="noopener">https://github.com/milovetingting/Samples/tree/master/Shell/%E5%8A%A0%E5%9B%BA-gradle%E6%8F%92%E4%BB%B6%E5%8A%A0%E5%A3%B3</a></p>
<h2 id="插件的实现"><a href="#插件的实现" class="headerlink" title="插件的实现"></a>插件的实现</h2><p>上面的方案，实际操作起来还是比较麻烦。因此，可以定义一个插件，通过引入这个插件，来实现apk的加固，减少编码的工作量。</p>
<p>可以参考下一篇文章：<a href="/2020/04/04/Android/Android应用加固的简单实现方案(二)/">Android应用加固的简单实现方案(二)</a></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:milovetingting@gmail.com">milovetingting</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://www.milovetingting.cn/2020/04/01/Android/Android%E5%BA%94%E7%94%A8%E5%8A%A0%E5%9B%BA%E7%9A%84%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88/">http://www.milovetingting.cn/2020/04/01/Android/Android%E5%BA%94%E7%94%A8%E5%8A%A0%E5%9B%BA%E7%9A%84%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://www.milovetingting.cn">milovetingting</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Android/">Android    </a><a class="post-meta__tags" href="/tags/%E5%8A%A0%E5%9B%BA/">加固    </a></div><div class="post_share"><div class="social-share" data-image="/images/cover_android.jpg" data-sites="facebook,twitter,wechat,weibo"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2020/04/04/Android/Android%E5%BA%94%E7%94%A8%E5%8A%A0%E5%9B%BA%E7%9A%84%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88(%E4%BA%8C)/"><img class="prev_cover lazyload" data-src="/images/cover_android.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>Android应用加固的简单实现方案(二)</span></div></a></div><div class="next-post pull_right"><a href="/2020/03/16/Android/Android%E4%B8%ADANR%E7%9A%84%E8%A7%A6%E5%8F%91%E6%9C%BA%E5%88%B6-BroadcastReceiver%E7%AF%87/"><img class="next_cover lazyload" data-src="/images/cover_android.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>Android中ANR的触发机制-BroadcastReceiver篇</span></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2020/04/04/Android/Android应用加固的简单实现方案(二)/" title="Android应用加固的简单实现方案(二)"><img class="relatedPosts_cover lazyload"data-src="/images/cover_android.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-04-30</div><div class="relatedPosts_title">Android应用加固的简单实现方案(二)</div></div></a></div><div class="relatedPosts_item"><a href="/2020/03/03/Android/Android中网络框架的简单封装/" title="Android中网络框架的简单封装"><img class="relatedPosts_cover lazyload"data-src="/images/cover_android.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-04-30</div><div class="relatedPosts_title">Android中网络框架的简单封装</div></div></a></div><div class="relatedPosts_item"><a href="/2020/04/18/Android/Jetpack学习-Paging/" title="Jetpack学习-Paging"><img class="relatedPosts_cover lazyload"data-src="/images/cover_android.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-04-30</div><div class="relatedPosts_title">Jetpack学习-Paging</div></div></a></div><div class="relatedPosts_item"><a href="/2020/04/17/Android/Jetpack学习-Navigation/" title="Jetpack学习-Navigation"><img class="relatedPosts_cover lazyload"data-src="/images/cover_android.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-04-30</div><div class="relatedPosts_title">Jetpack学习-Navigation</div></div></a></div><div class="relatedPosts_item"><a href="/2020/04/16/Android/Jetpack学习-Room/" title="Jetpack学习-Room"><img class="relatedPosts_cover lazyload"data-src="/images/cover_android.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-04-30</div><div class="relatedPosts_title">Jetpack学习-Room</div></div></a></div><div class="relatedPosts_item"><a href="/2020/04/15/Android/Jetpack学习-DataBinding/" title="Jetpack学习-DataBinding"><img class="relatedPosts_cover lazyload"data-src="/images/cover_android.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-04-30</div><div class="relatedPosts_title">Jetpack学习-DataBinding</div></div></a></div></div><div class="clear_both"></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: 'ae38b55ae64dd8d9df5a',
  clientSecret: '684ea96fb1acf523a5f8a2a84eb751c33ca645a4',
  repo: 'milovetingting.github.io',
  owner: 'milovetingting',
  admin: 'milovetingting',
  id: md5(decodeURI(location.pathname)),
  language: 'zh-CN# en , zh-CN , zh-TW',
  updateCountCallback: commentCount
})
gitalk.render('gitalk-container')

function commentCount(n){
  document.getElementsByClassName('gitalk-comment-count')[0].innerHTML= n
}</script></div></div></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2020 By milovetingting</div><div class="framework-info"><span>驱动 </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="https://cdn.jsdelivr.net/npm/activate-power-mode/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true; 
document.body.addEventListener('input', POWERMODE);
</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>